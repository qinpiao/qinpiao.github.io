---
layout: post
title:  "从零开始gorm(三)"
date:   2019-06-03 13:20:42
categories: ORM Go
tags: ORM Go
---

* content
{:toc}



## 增删查改

### 新增

#### 创建记录 

一般的,我们使用`Create`来创建新的记录,当我们需要手动指定一条数据的主键时,在插入数据前可以使用`NewRecord`判断
库中是否已经存在主键值相同的数据;插入数据后,我们也可以使用`NewRecord`来检查数据是否确实插入到了库中

```go

user := User{Name: "test", Age:18, Brithday: time.Now()}


// 会检查数据库内是否有主键值为传入的值的数据存在,如果存在说明主键重复,会返回false
db.NewRecord(user) // ==> user内未填写主键字段的值,返回true

// Create往库内插入一条数据
db.Create(&user)

// 再次调用newRecord,此时user的主键字段被填充值,再调用newRecord会返回false,说明数据已经插入到库中
db.NewRecord(user) // ==> user数据已经被插入到库中,此时返回false

```

#### 默认值


可以通过声明字段的`default`来修改字段的默认值,默认值为`tag`的内容;
当我们执行插入时,如果未对字段进行赋值或是给字段赋予了零值的情况下, 
`gorm`在生成插入SQL时会自动过滤掉这些未经过设置的字段,数据被成功插入到数据库后,`gorm`会从数据库中将之前未设置的
字段的值加载回字段中

```go

type Animal struct {
	ID      int64
	Name    string      `gorm:"default:galeone"`
	Age     int64
}


var animal = Animal{Agent:99,}

db.Create(&animal)
// INSERT INTO animals (age) values(99);
//插入成功后,会从数据库加载字段值
// animal.Name ==> "galeone" 

```

**所有的字段都有一个类型零值,比如0, "",false或是其它的零值,如果字段设置了默认值,此时给字段赋予类型零值,
进行插入操作时,将会使用设置的默认值替代零值;
如果设置了默认值但是确实需要给该记录的字段赋予类型零值,可以将字段设置为指针类型或是scanner/valuer类型**

```go

// 使用指针类型
type User struct {
	gorm.Model
	Name        string
	Age         *int        `gorm:"default:18"`
}


// 使用 scanner/valuer
type User struct {
	gorm.Model
	Name            string
	Age             sql.NullInt64   `gorm:"default:18"`
}

```

#### 在hook中设置字段的值

`gorm`提供了`BeforeCreate`hook,比如我们可以通过使用`scope.SetColumn`来设置字段值

```go

func (user *User) BeforeCreate(scope *gorm.Scope) error {
	scope.SetColumn("ID", uuid.New())
	return nil
}
```


#### 扩展创建选项

`gorm`提供了`Set`方法用于扩展SQL选项

```go

db.Set("gorm:insert_option", "ON CONFLICT").Create(&User)
// INSERT INTO users (name, age) VALUES ("jack", 18) ON CONFLICT;

```



### 查询

#### query

`gorm`提供了多种用于查询的接口

```go

// 使用primary key排序,并获取第一条记录
db.Frist(&user)
// SELECT * FROM users ORDER BY id LIMIT 1;

//返回一条数据
db.Take(&user)
// SELECT * FROM users LIMIT 1;

// 使用 primary key 排序,获取最后一条记录
db.Last(&user)
// SELECT * FROM users ORDER BY id DESC LIMIT 1;

// 获取所有数据
db.Find(&User)
// 


//
```



