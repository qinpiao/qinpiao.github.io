---
layout: post
title:  "从零开始gorm(四)"
date:   2019-06-10 13:26:42
categories: ORM Go
tags: ORM Go
---

* content
{:toc}



## 关联

### Belongs To

`belong to`设置了一个`one-to-one`的关联连接,例如:每个用户拥有一份配置文件

```go

type User struct {
	gorm.Model
	Name            string
}


// Profile 属于 user, UserId 为外键
type Profile struct{
	gorm.Model
	UserId          int
	User            User
	Name            string
}

```

#### Foreign Key

当我们定义了一个`one-to-one`的`belong to`关系时,默认的必须要有一个以所有者类型名称和主键组成的外键字段
如上诉的例子中, 为了定义`Profile`属于`User`, Profile内定义了用作外键的字段`UserId`

我们还可以自己指定用于作为外键的字段

```go

type User struct {
	gorm.Model
	Name            string
}

type Profile struct{
	gorm.Model
	Name            string
	User            User        `gorm:"foreignkey: UserRefer"` // 设置使用UserRefer字段作为外键
	UserRefer       string
	
}

```

#### Association ForeignKey

对于一个`belong to`关系,如上面的例子一样,gorm默认会使用owner的主键作为外键值,gorm会将`User`的`Id`存入到`Profile`的`UserId`字段中,
我们也可以使用`association_foreignkery`手动指定作为外键值的字段

```go

type User struct {
	gorm.Model
	Name            string
	Refer           int
}


type Profile struct {
	gorm.Model
	Name            string
	User            User        `gorm:"association_foreignkey:Refer"`
	UserRefer       string
}


```

#### 使用 Belongs to

可以使用`Relate`来查找`belongs to`关系

```go

db.Model(&user).Related(&profile)
// SELECT * FROM profiles WHERE user_id = 1;
```

### Has One

`Has One`同样定义了`one-to-one`关系,和`belong to`的区别在于`has one`是在owner中进行定义的:
`A`属于`B`的关系`belong to`是在`B`中定义两者的关系,而`Has one`是在`A`中定义两者的关系

```go

type CreditCard struct {
	gorm.Model
	Number          string
	UserId          uint
}

type User struct{
	gorm.Model
	Name            string
	CreditCard      CreditCard
}

```

#### Foreign Key

同样的,对于`has one`关系来说,默认必须存在一个owner的Model类型加主键名命名的字段作为外键字段
你也可以自己定义外键使用的字段:

```go

type CreditCard struct {
	gorm.Model
	Number          string
	UserName        string
}

type User struct{
	gorm.Model
	Name            string
	CreditCard      CreditCard      `gorm:"foreignkey:UserName"` //改用UserName作为外键
}

```

#### Association ForeignKey

默认的`gorm`会将owner的主键值保存到外键字段中,我们同样可以使用`Association ForeignKey`来修改作为外键字段填充值的字段

```go
type CreditCard struct {
	gorm.Model
	Number          string
	UID             string
}

type User struct{
	gorm.Model
	Name            string          `sql: "index"`
	CreditCard      CreditCard      `gorm:"foreignkey:uid;association_foreignkey:name"` //改用UserName作为外键
}

```

#### 多态关联

***注意: 多态关联不能用于`belongs-to`和`many-to-many`***

```go

type Cat struct {
	ID      int
	Name    string
	Toy     Toy         `gorm:"polymorphic:Owner"`
}

type Dog struct{
	ID      int
	Name    string
	Toy     Toy         `gorm:"polymorphic:Owner"`
}

type Toy struct{
	ID          int
	Name        string
	OwnerID     int
	OwnerType   string
}

```

#### 使用 Has One

```go

var card CreditCard

db.Model(&user).Related(&card, "CreditCard")
// SELECT * FROM creadit_cards WHERE user_id = 1

// 上面的"CreditCard"是user的字段名,如果这个字段名和变量的类型名相同,可以省略不写
db.Model(&user).Related(&card)


```